쿠버네티스 클러스터 실습 환경 자동화

발표주제

윈도우 데스크톱 환경에서 PXE(Preboot Execution Environment) 및 Ansible을 활용한 쿠버네티스 클러스터 실습 환경 자동 구축

요약

본 발표는 윈도우 데스크톱 환경에서 쿠버네티스 실습 클러스터 구축 과정을 자동화한 프로젝트에 대해 다룬다. 기존에는 실습 중 클러스터가 손상될 경우, 가상머신(VM) 기반으로 OS를 재설치하고 노드를 다시 조인하는 데 2~3시간이 소요되는 비효율적인 문제가 있었다. 이 문제를 해결하고 인프라 레벨까지 깊이 있는 이해를 도모하기 위해 자동화 프로젝트를 시작했다.

프로젝트는 Windows 데스크톱의 Hyper-V 하이퍼바이저를 사용하여 여러 VM을 생성하고, PXE 네트워크 부팅 기술(TFTP, DHCP 활용)로 OS(Rocky Linux) 설치를 자동화했다. 이후, Ansible(IaC)을 활용하여 쿠버네티스 클러스터 설치, 노드 조인, CNI 설정, 스토리지 서버(NFS) 연동까지 전 과정을 자동화하여 전체 구축 시간을 약 30분으로 단축시켰다. 이를 통해 시간 절약은 물론, 반복적인 작업에서 발생하는 휴먼 에러를 방지하는 효과를 거두었다.

발표내용

1. 프로젝트 배경 및 목표

* 배경:
  * 미니큐브나 K3S와 같은 단일 노드 기반의 실습 툴은 쿠버네티스 인프라 레벨의 깊이 있는 이해에 한계가 있다고 판단했다.
  * 실습 중 클러스터가 손상될 때마다 VM OS 재설치부터 노드 조인까지 수동으로 복구하는 데 약 2~3시간이 소요되는 비효율성을 개선하고자 했다.
* 목표:
  * Windows 데스크톱 환경에서 VM 기반의 쿠버네티스 클러스터 구축 과정을 완전히 자동화한다.
  * 클러스터가 손상되더라도 약 30분 내에 신속하게 복구할 수 있는 환경을 구축한다.
  * 자동화 과정 구축을 통해 인프라에 대한 실질적인 이해도를 높인다.

2. 시스템 아키텍처

* 물리적 환경: 2대의 Windows 데스크톱 PC를 활용했다.
* 가상화: 각 PC에 Hyper-V 하이퍼바이저를 사용하여 총 6대의 VM을 구성했다.
* VM 역할 구성:
  * 컨트롤 플레인 노드: 1대
  * 컴퓨트 노드 (워커 노드): 3대
  * 스토리지 서버: 1대 (NFS)
  * 부트스트랩 서버: 1대 (PXE 서버 및 Ansible 컨트롤 노드 역할)
* 네트워크 구성:
  * Hyper-V의 가상 스위치 기능을 사용하여 2대의 물리적 PC에 분산된 VM들을 동일 네트워크 대역으로 연결했다.
  * 실제 IDC 환경과 유사하게 네트워크를 분리하여 구성했다.
    * MGMT 네트워크: PXE 및 Ansible 관리 통신용
    * 내부 통신용 네트워크: 쿠버네티스 클러스터 내부 통신용 (파드 간 통신 등)
    * 외부 통신용 네트워크: 인터넷 등 외부 통신용

3. 핵심 기술 (1): PXE를 이용한 OS 설치 자동화

* PXE (Preboot Execution Environment): 네트워크를 통해 원격으로 OS를 설치하고 부팅하는 기술로, 주로 베어메탈 서버 환경에서 사용된다.
* 자동화 프로세스:
  1. VM이 부팅되며 BIOS/UEFI 단계에서 DHCP 서버에 IP 주소를 요청한다.
  2. DHCP 서버는 IP 주소와 함께 부트로더 파일이 있는 TFTP 서버 정보를 전달한다.
  3. VM은 TFTP 서버로부터 부트로더, 커널 이미지, initrd (램디스크) 파일을 다운로드한다.
  4. 이후 킥스타트(Kickstart) 스크립트를 통해 Rocky Linux OS 설치의 모든 과정(파티션 설정, 패키지 설치 등)이 자동으로 진행된다.
* 구현 상세:
  * PXE 환경 구축(TFTP 서버, DHCP 서버 설정, 이미지 파일 준비 등)을 위한 작업은 배시(Bash) 스크립트로 자동화했다.
  * DHCP 서버에 각 VM의 MAC 주소를 등록하여 고정 IP를 할당함으로써, 지정된 VM에 정확한 역할의 OS가 설치되도록 구성했다.

4. 핵심 기술 (2): Ansible을 이용한 쿠버네티스 클러스터 구축 자동화

* Ansible: SSH 프로토콜을 기반으로 동작하는 IaC(Infrastructure as Code) 툴로, OS 설치 후의 모든 설정 작업을 자동화하는 데 사용했다.
* 자동화 단계 (5단계):
  1. 부트스트랩 서버 준비: Ansible 설치 및 각 VM의 호스트 정보, 변수, SSH 키 등을 설정한다.
  2. VM 초기 설정: 쿠버네티스 설치에 필요한 사전 작업(스왑 메모리 비활성화, 커널 모듈 설정 등)을 모든 노드에 일괄 적용한다.
  3. 컨트롤 플레인 노드 설정: 쿠버네티스 리포지토리를 추가하고 kubeadm 등 관련 패키지를 설치하여 컨트롤 플레인을 초기화한다.
  4. 컴퓨트 노드 설정: kubeadm join 명령어를 통해 컴퓨트 노드들을 클러스터에 조인시킨다.
  5. 스토리지 연동: NFS 서버를 설정하고 클러스터에 마운트하여 영구 볼륨을 사용할 수 있도록 구성한다.
* 구현 상세: Ansible의 문법에 맞춰 YAML 형식의 플레이북(Playbook) 파일을 작성하여 위 5단계의 작업을 순차적으로 실행하도록 했다.

5. 시연 및 결과

* 시연 영상을 통해 자동화된 전체 과정을 선보였다.
* PXE 부팅: Hyper-V에서 VM들의 전원을 켜자, 수동 개입 없이 자동으로 네트워크 부팅이 시작되고 OS 설치가 완료되는 모습을 시연했다.
* Ansible 실행: 부트스트랩 서버에서 Ansible 명령어를 실행하자, SSH를 통해 각 VM에 순차적으로 접속하여 쿠버네티스 클러스터가 구축되고 노드가 조인되는 과정을 보여주었다.
* 최종 검증: 구축된 클러스터에서 kubectl 명령어를 통해 노드 상태를 확인하고, Nginx 파드를 배포하여 서비스가 정상적으로 노출되는 것을 확인하며 자동화가 성공적으로 완료되었음을 증명했다.

결론

이 프로젝트를 통해 반복적이고 시간이 많이 소요되던 쿠버네티스 실습 환경 구축 작업을 성공적으로 자동화했다. 이를 통해 얻은 핵심적인 성과는 다음과 같다.

1. 시간 효율성 증대: 수동으로 2~3시간 걸리던 작업을 약 30분으로 단축하여 신속한 환경 복구 및 실습 준비가 가능해졌다.
2. 휴먼 에러 방지: 모든 과정이 코드로 관리되어 수동 작업 시 발생할 수 있는 실수를 원천적으로 차단하고 일관된 환경을 보장했다.
3. 심도 있는 학습 경험: 자동화를 직접 구현하는 과정에서 쿠버네티스 CNI, 네트워크 아키텍처, PXE 동작 원리 등 인프라 전반에 대한 깊이 있는 지식과 트러블슈팅 경험을 쌓을 수 있었다.

## QnA

| 질문자 | 질문 내용 | 답변자 | 답변 내용 |
|:---:|---|:---:|---|
| 화자 1 | 2대의 물리적 PC를 사용했는데, PXE 서버는 어디에 위치했는가? | 화자 6 | 부트스트랩 서버 역할을 하는 VM 내에 PXE 서버를 구축했다. 네트워크 부팅을 위해 모든 VM이 동일 브로드캐스트 도메인에 있어야 하므로, Hyper-V의 가상 스위치 기능으로 두 물리적 PC에 걸쳐있는 VM들을 하나의 네트워크로 묶었다. |
| 화자 1 | 물리적으로 분리된 2대의 PC에 있는 Hyper-V가 어떻게 하나의 가상 스위치를 공유할 수 있었는가? 네트워크 연결 방식이 궁금하다. | 화자 6 | 두 PC는 같은 실습실 내 동일한 물리적 네트워크에 연결되어 있었다. Hyper-V는 물리적 네트워크 어댑터를 공유하는 외부(External) 가상 스위치를 생성할 수 있다. 이 기능을 사용해 각기 다른 호스트에 있는 VM들이 서로 통신할 수 있도록 구성했다. 이 부분이 프로젝트에서 가장 많은 트러블슈팅을 유발한 지점이었다. |
| 화자 1 | 쿠버네티스에서 왜 최소 2개 이상의 네트워크(VLAN)가 필요한가? | 화자 6 | 클러스터 내부에서 파드(Pod)끼리 통신하는 내부 네트워크와, 인터넷 등 외부 서비스와 통신하기 위한 외부 네트워크가 최소한으로 필요하다. 실제 데이터센터(IDC) 환경에서는 보안 및 관리 목적으로 더 많은 네트워크 레이어를 사용한다. |
