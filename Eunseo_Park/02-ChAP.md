# 카오스 엔지니어링과 넷플릭스 ChAP

## 1. 카오스 엔지니어링의 개념

카오스 엔지니어링(Chaos Engineering)이란 시스템이 어떻게 회복하는지 검증하기 위해 의도적으로 장애를 주입하는 행위이다.
즉, 정상 상태에서 벗어난 환경을 만들어 시스템의 복원력(Resilience) 을 검증하는 접근법이다.

일반적인 부하 테스트가 “얼마나 버틸 수 있는가”를 측정하는 실험이라면,
카오스 엔지니어링은 “버티지 못할 때 시스템이 어떻게 망가지고, 어떻게 복구되는가”를 관찰하는 실험이다.
이는 단순한 성능 시험이 아니라 시스템의 회복 능력을 수치적으로 확인하는 과정이다.

카오스 엔지니어링은 단순히 서버를 죽이거나 네트워크를 느리게 만드는 것을 넘어,
API 호출 실패, 인스턴스 종료, 업데이트 오류 등 현실적인 장애 시나리오를 실험적으로 재현한다.
이 과정에서 시스템이 어떻게 대응하는지를 관찰하고, 문제를 미리 수정함으로써
실제 장애가 발생하기 전에 복원력을 강화할 수 있다.

## 2. Shopify 사례: 실패를 먼저 경험한 조직

Shopify
는
누구나 프로그래밍 지식 없이 온라인 스토어를 구축하고 결제 및 배송을 관리할 수 있는
전자상거래 플랫폼이다.

이 회사는 매년 블랙프라이데이 시즌에 평소보다 수십 배 많은 트래픽을 처리해야 하는데,
당시 가장 큰 문제는 결제 실패가 곧바로 매출 손실로 이어진다는 점이었다.
단순한 부하 테스트만으로는 이러한 실제 문제를 예측하기 어려웠다.
실제 운영 환경에서는 카드사 응답 지연, 서버 과부하, 네트워크 불안정 등
여러 비정상 상황이 동시에 발생하기 때문이다.

Shopify는 이에 대한 대응으로 카오스 엔지니어링을 도입하였다.
실제 결제 API 일부를 의도적으로 중단시키는 실험을 수행하여
결제가 실패하는 상황에서 시스템이 어떻게 반응하는지를 검증하였다.
그 결과, 결제 실패 시 장바구니가 비워지거나 재고가 잘못 차감되는 문제를 발견하였다.

이후 시스템을 개선하여 결제가 실패해도
장바구니와 재고 상태가 유지되도록 수정하였으며,
중복 결제 방지를 위한 로직도 강화하였다.
그 결과 블랙프라이데이 시즌에도 다운타임 없이 모든 거래를 처리할 수 있었다.

이 사례는 단순한 QA나 스트레스 테스트로는 발견할 수 없는
‘실패 이후의 시스템 반응’을 미리 경험함으로써
안정적인 서비스를 유지할 수 있음을 보여주는 대표적인 예시이다.
즉, 카오스 엔지니어링은 단순한 테스트가 아닌,
예방적 복원력 확보 전략임을 증명한 사례라 할 수 있다.

## 3. 수동 카오스 실험의 한계

초기의 카오스 엔지니어링은 대부분 사람이 직접 시나리오를 설계하고
수동으로 수행하는 방식이었다.
예를 들어 엔지니어가 “이 서버 두 대를 꺼보자” 혹은 “이 네트워크 경로를 느려지게 하자”와 같은
가정적 실험을 수동으로 반복하는 식이었다.

그러나 이러한 접근 방식에는 명확한 한계가 존재하였다.

사람 의존적 설계: 시나리오의 커버리지가 제한적이다.

랜덤 킬링 방식: 연쇄적 장애(서비스 지연 → 큐 적체 → 커넥션 풀 고갈 → 타임아웃 확산)를 포착하기 어렵다.

수동 수행: 실험 속도가 실제 배포 속도를 따라가지 못한다.

안전성 부족: 블라스트 반경(실험 영향 범위)을 세밀하게 제어하기 어렵다.

결국 마이크로서비스 수백 개가 매일 수십 차례 배포되는 환경에서는
사람이 수동으로 설계하고 조작하는 방식이 현실적으로 불가능하였다.
넷플릭스는 이 한계를 해결하기 위해 카오스 실험의 자동화를 추진하였다.

## 4. 넷플릭스의 ChAP (Chaos Automation Platform)

넷플릭스는 과거 Chaos Monkey, Latency Monkey, Chaos Gorilla 등
‘카오스 몽키(Chaos Monkey)’ 시리즈 도구를 활용해
장애 내성을 실험해 왔다.

Chaos Monkey: 운영 인스턴스를 무작위로 종료하여 서비스 지속성을 검증한다.

Latency Monkey: 인위적인 지연(latency)을 삽입해 타임아웃, 재시도, 폴백 로직을 검증한다.

Chaos Gorilla / Kong: 가용영역(AZ) 또는 리전(region) 전체 장애를 가정하여
멀티 리전 아키텍처의 복원력을 확인한다.

이러한 방식은 탄력성 강화에 효과적이었지만,
랜덤 방식에 의존했기 때문에 정밀한 제어가 어렵고,
연쇄 장애를 체계적으로 검증할 수 없다는 한계가 있었다.
또한 실험 속도가 배포 속도보다 느려 CI/CD 파이프라인과 통합되지 않는 문제도 존재했다.

이를 해결하기 위해 넷플릭스는
프로덕션 환경에서 카오스 실험을 자동화하는 플랫폼인
ChAP(Chaos Automation Platform)
을 개발하였다.

## 5. ChAP의 구조와 동작 방식

ChAP는 운영 트래픽을 정상 집단(컨트롤) 과 실험 집단으로 자동 분리한 뒤,
극히 일부(0.1% 이하)의 트래픽을 실험군으로 지정한다.
그 후 실험군에만 정밀한 실패(Fault Injection) 를 주입하고
양 집단의 성능 차이를 자동으로 측정·분석한다.

주입되는 장애 유형은 다음과 같다.

실패 응답 주입: 특정 호출에서 의도적으로 오류(HTTP 5xx, RPC 에러 등)를 반환한다.

지연 주입: 응답에 200~500ms의 인위적 지연을 삽입한다.

드롭/타임아웃 주입: 요청을 무응답 상태로 두어 타임아웃을 유도한다.

실험 도중 ChAP는 컨트롤 그룹과 실험 그룹의 SPS(초당 재생 시작 수), 오류율, P95/P99 지연시간을
실시간으로 비교한다.
지표가 사전에 정의된 임계치를 초과하면 즉시 실험을 중단하고 실험군을 격리한다.
이 모든 과정은 자동으로 수행되며, 사람의 개입이 필요하지 않다.

ChAP의 핵심 원칙은 다음 네 가지이다.

실험군 최소화: 블라스트 반경을 최소화하여 안전성을 확보한다.

정밀한 실패 주입: FIT(Fault Injection Testing) 엔진을 통해 세밀하게 제어한다.

지표 기반 자동 판정: 감각이 아닌 수치 기반으로 판단한다.

즉시 중단 및 격리: 위험 감지 시 자동으로 실험을 종료하고 영향 범위를 차단한다.

이러한 구조를 통해 ChAP는
“작게, 자주, 안전하게 실패를 경험하도록” 시스템이 스스로 학습하게 만든다.

## 6. 실제 발견된 취약점 사례

넷플릭스는 ChAP 실험을 통해 여러 실제 취약점을 사전에 발견하였다.

무거운 폴백(Fallback) 문제:
장애 시 폴백 로직이 오히려 더 많은 CPU와 메모리를 사용해
정상 경로보다 느려지는 현상이 발견되었다.
ChAP 실험 결과를 바탕으로 폴백 경로를 경량화하여 수정하였다.

재시도 폭주(Retry Storm) 문제:
약 900ms의 인위적 지연을 주입한 결과,
재시도가 집중되면서 스레드 풀이 고갈되고 타임아웃이 연쇄적으로 발생하였다.
이를 통해 백오프 간격 조정, 재시도 상한 설정, 풀 크기 재조정 등의 개선이 이루어졌다.
(참고: arXiv:1905.04648
)

서킷 브레이커 상호작용 버그:
서비스 간 회로 차단기의 임계치와 쿨다운 설정이 일관되지 않아
연쇄 타임아웃이 발생하던 문제가 있었다.
ChAP와 Monocle 대시보드를 연동해 해당 현상을 자동 탐지하고
각 서비스의 타임아웃·쿨다운 값을 표준화하였다.
(참고: InfoQ — Resilience of Services at Netflix
)

이처럼 ChAP는 정상 테스트로는 발견할 수 없는
복잡한 상호작용 오류를 데이터 기반으로 사전에 탐지할 수 있게 해주었다.

## 7. ChAP 도입의 효과

ChAP가 도입된 이후 넷플릭스의 운영 체계는 다음과 같이 변화하였다.

프로덕션 실험의 표준화:
“작은 실험군 → 정밀 주입 → 지표 판정 → 자동 중단” 프로세스가 템플릿화되어
누구나 안전하게 실험을 수행할 수 있게 되었다.

지표 중심 의사결정:
감각이 아닌 수치로 리스크를 판단하고,
장애 대응과 복원력 향상 여부를 데이터 기반으로 증명할 수 있게 되었다.

MTTR 감소:
잠재적 취약점을 사전에 발견·수정함으로써
평균 복구 시간(Mean Time To Recovery)이 단축되었다.

배포 속도 유지:
ChAP는 Spinnaker 배포 파이프라인과 통합되어
새 버전이 배포될 때마다 자동으로 실험을 수행하고
결과에 따라 확장 또는 롤백을 결정한다.
이를 통해 속도와 안정성을 동시에 확보하였다.

## 8. 결론: 자동화 없는 복원력은 존재하지 않는다

대규모 인프라 환경에서 복원력은 단순히 장애 대응 매뉴얼로 확보되지 않는다.
복원력은 실패를 통제하고, 작게 반복하며, 빠르게 피드백을 받는 자동화된 루프를 통해 만들어진다.

넷플릭스의 ChAP는 이러한 루프를 시스템 수준에서 구현한 대표적인 사례이다.
ChAP를 통해 넷플릭스는 “작게, 자주, 안전하게 실패를 겪고 배우는 구조”를 확보하였고,
이를 데이터로 증명함으로써 장애 대응 문화를 혁신하였다.

결국 자동화 없는 복원력은 없다!
ChAP는 그 명제를 기술적으로 입증한 실질적 사례이며,
자동화가 복원력의 전제 조건임을 보여주는 대표적 사례이다.

참고 문헌 및 자료

https://shopify.engineering/preparing-shopify-for-black-friday-cyber-monday

https://netflixtechblog.com/chap-chaos-automation-platform-53e6d528371f

https://www.infoq.com/news/2017/11/resilience-services-netflix/

https://arxiv.org/pdf/1905.04648